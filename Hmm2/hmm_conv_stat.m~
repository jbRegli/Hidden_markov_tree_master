function error_LW = ...
    hmm_conv_stat(cv_ach_strct, cv_sens)
% hmm_conv_stat: CONVERGENCE TEST FOR EM ALGORITHM
%   Given a theta at step n and theta at step n-1, this function asseses if
%   convergence has occcured.

    %% Preparation:
    % optional variables:
    
    % Sizes:
    n_layer = length(cv_ach_strct);
    s_image = size(cv_ach_strct{1}.proba{1}(:,:,1));
    n_pixel = prod(s_image);
    n_state = size(cv_ach_strct{1}.proba{1},3);
    n_scale = zeros(1,n_layer);
    

    % Structure to store convergence error:
    error_LW = cell(1, n_layer);

    for layer=1:n_layer   
        if layer ==  1
            n_scale(1,layer) = length(cv_ach_strct{layer}.proba);
            
            % Structure:
            error_LW{layer}.proba = cell(1,n_scale(1,layer));
            error_LW{layer}.global = 0;

        else
            n_scale(1,layer) = length(cv_ach_strct{layer}.mu);
            
            % Structure:
            error_LW{layer}.epsilon = cell(1,n_scale(1,layer));
            error_LW{layer}.mu = cell(1,n_scale(1,layer));
            error_LW{layer}.sigma = cell(1,n_scale(1,layer));
            error_LW{layer}.golbal = 0;

        end
    end
       
    %% Convergence error:
    % Loop over the layers:
    for layer=1:n_layer 
        fields = fieldnames(error_LW{layer});    
        
        %  Loop over the scales at 'layer':
        for scale=1:n_scale(1,layer)
            for i=1:numel(fields)                     
                if ~strcmp(fields{i},'global') 
                    % Count:
                    tmp_count = ...
                        cv_ach_strct{layer}.(fields{i}){scale} > cv_sens;

                            % Cv achieve general:
                            if strcmp(fields{i},'epsilon')
                                error_LW{layer}.(field{i}){scale} = ...
                                    sum(sum(sum(sum(tmp_count,4),3),2),1) ...
                                    / (4 * n_pixel);
                            else
                                error_LW{layer}.(field{i}){scale} = ...
                                    sum(sum(sum(tmp_count,3),2),1) ...
                                    / (2 * n_pixel);
                            end

                            
                                  
                        end
                    end
                end
            end
        end
    else
        cv_ach_bool = false;
    end
end

